<!doctype html>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<head>
  <title>APT-GRAPH</title>
  <!-- CSS -->
  <link rel="stylesheet" type="text/css" href="css/stylesheet.css">
  <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
  <link rel="stylesheet" href="chartist/chartist.min.css">
  <link rel="stylesheet" href="chartist/tooltip/chartist-plugin-tooltip.css">
</head>
<body>
  <!-- Js -->
  <script src="js/libs/jquery-3.1.1.min.js"></script>
  <script src="js/libs/d3.min.js"></script>
  <script src="js/libs/bootstrap.min.js"></script>
  <script src="js/graph.js"></script>
  <script src="js/json_methods.js"></script>
  <script src="js/change_visibility.js"></script>
  <script src="chartist/chartist.js"></script>
  <script src="chartist/axistitle/chartist-plugin-axistitle.js"></script>
  <script src="chartist/tooltip/chartist-plugin-tooltip.js"></script>
  <script src="chartist/zoom/chartist-plugin-zoom.min.js"></script>

  <div class="container-fluid" id="container">
    <div class="row" id="parent">
      <div class="col-md-3" id="side_bar">
        <h3>PARAMETERS</h3>
        <div class="form-group" id="side_bar_group">
          <div class="container-fluid" id="choice_user">
            <h4>CHOICE OF USER</h4>
              <div class="dropdown" id="user-list">
                <a class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" href="#" id="selected-user">User List<span class="caret"></span></a>
                <ul class="dropdown-menu">
                </ul>
              </div> 
          </div>
          <div class="container-fluid" id="feature_fusion">
            <h4>FEATURE FUSION</h4>
            <h5>FEATURE WEIGHTS</h5>
            <div class="form-horizontal">
              <div class="form-group">
                <label for="time" class="col-md-4 control-label" style="text-align: left; width: 100px">TIME:</label>
                <div class="col-md-2">
                  <input type="number" step="0.1" class="form-control" id="time" value="0.6" style="width: 80px;">
                </div>
              </div>
              <div class="form-group">
                <label for="url" class="col-md-4 control-label" style="text-align: left; width: 100px">URL:</label>
                <div class="col-md-2">
                  <input type="number" step="0.1" class="form-control" id="url" value="0" style="width: 80px;">
                </div>
              </div>
              <div class="form-group">
                <label for="domain" class="col-md-4 control-label" style="text-align: left; width: 100px">DOMAIN:</label>
                <div class="col-md-2">
                  <input type="number" step="0.1" class="form-control" id="domain" value="0.4" style="width: 80px;">
                </div>
              </div>
              <div class="form-group">
                <label for="children" class="col-md-4 control-label" style="text-align: left; width: 200px">TEMPORAL CHILDREN:</label>
                <div class="col-md-2">
                  <input type="checkbox" id="children" value="" checked>
                </div>
              </div>
            </div>
            <h5>ORDERED WEIGHTS</h5>
            <div class="form-group">
              <input type="number" class="form-control" id="ord_weights_high" value="0.8" style="width: 80px; float: left; margin-right: 10px;">
              <input type="number" class="form-control" id="ord_weights_low" value="0.2" style="width: 80px; float: left; margin-right: 10px;">
            </div>
          </div>
          <div class="container-fluid" id="domain_clustering">
            <h4>DOMAIN CLUSTERING</h4>
            <h5>PRUNE THRESHOLD</h5>
            <div class="form-horizontal">
              <div class="form-group">
                <div class="col-md-12">
                  <input type="number" step="0.01" class="form-control" id="prune_threshold" value="-0.25" style="width: 80px; float: left; margin-right: 10px;">
                  <button type="button" class="btn btn-default" data-toggle="modal" data-target="#histogram_pruning" style="width: 100px; float: left; margin-right: 10px">
                    Histogram
                  </button>
                  <div class="modal fade" id="histogram_pruning" role="dialog">
                    <div class="modal-dialog modal-lg">
                      <div class="modal-content">
                        <div class="modal-header">
                          <button type="button" class="close" data-dismiss="modal">&times;</button>
                          <h2 class="modal-title">Pruning Threshold Histogram</h2>
                        </div>
                        <div class="modal-body" id="hist_pruning">
                          <div class="ct-chart ct-perfect-fourth" id="chart_pruning"></div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-default" id="reset_button_pruning" style="display:none">Reset Zoom</button>
                          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-12">
    	              <label for="prune_absolute" class="col-md-4 control-label" style="text-align: left; width: 150px;">Absolute value:</label>
    	              <div class="col-md-2">
    	                <input type="checkbox" id="prune_absolute" value="">
    	              </div>
                  </div>
                  <div class="col-md-12">
    	              <label for="prune_z" class="col-md-4 control-label" style="text-align: left; width: 150px;">Z score:</label>
    	              <div class="col-md-2">
    	                <input type="checkbox" id="prune_z" value="" checked="">
    	              </div>
                  </div>
                </div>
              </div>
            </div>
            <h5>MAX CLUSTER SIZE</h5>
            <div class="form-horizontal">
              <div class="form-group">
                <div class="col-md-12">
                  <input type="number" step="0.01" class="form-control" id="max_cluster_size" value="0" style="width: 80px; float: left; margin-right: 10px;">
                  <button type="button" class="btn btn-default" data-toggle="modal" data-target="#histogram_cluster" style="width: 100px; float: left; margin-right: 10px;">
                    Histogram
                  </button>
                  <div class="modal fade" id="histogram_cluster" role="dialog">
                    <div class="modal-dialog modal-lg">
                      <div class="modal-content">
                        <div class="modal-header">
                          <button type="button" class="close" data-dismiss="modal">&times;</button>
                          <h2 class="modal-title">Cluster Size Histogram</h2>
                        </div>
                        <div class="modal-body" id="hist_cluster">
                          <div class="ct-chart ct-perfect-fourth" id="chart_cluster"></div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-default" id="reset_button_cluster" style="display:none">Reset Zoom</button>
                          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-12">
    	              <label for="cluster_absolute" class="col-md-4 control-label" style="text-align: left; width: 150px;">Absolute value:</label>
    	              <div class="col-md-2">
    	                <input type="checkbox" id="cluster_absolute" value="">
    	              </div>
                	</div>
                	<div class="col-md-12">
    	              <label for="cluster_z" class="col-md-4 control-label" style="text-align: left; width: 150px;">Z score:</label>
    	              <div class="col-md-2">
    	                <input type="checkbox" id="cluster_z" value="" checked="">
    	              </div>
                	</div>
                </div>
              </div>
            </div> 
          </div>
          <div class="container-fluid" id="domain_display">
            <h4>DOMAIN DISPLAY</h4>
            <div class="form-horizontal">
              <div class="form-group">
               <label for="whitelist" class="col-md-4 control-label" style="text-align: left; width: 200px;">WHITE LISTING</label>
               <div class="col-md-2">
                 <input type="checkbox" id="whitelist" value="" checked>
               </div>
              </div>
            </div>  
          </div>
          <div class="container-fluid" id="log_details">
            <h4>LOG DETAILS</h4>
            <div class="form-horizontal">
              <div class="form-group">
                <label for="request_text_show" class="col-md-4 control-label" style="text-align: left; width: 160px;">Selected Domains:</label>
                <button type="button" class="btn btn-default" data-toggle="modal" id="request_text_show" data-target="#request_text_modal">Show Requests</button>
                <div class="modal fade" id="request_text_modal" role="dialog">
                    <div class="modal-dialog modal-lg">
                      <div class="modal-content">
                        <div class="modal-header">
                          <button type="button" class="close" data-dismiss="modal">&times;</button>
                          <h2 class="modal-title">Requests of selected domains</h2>
                        </div>
                        <div class="modal-body" id="request_text">
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-default" id="show_all_domains_button" style="display:none">Print all domains</button>
                          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                      </div>
                    </div>
                  </div>
              </div>
            </div>
          </div>
          <div class="container-fluid" id="buttons">
            <button type="button" class="btn btn-primary" id="apply_button">Apply</button>
            <button type="button" class="btn btn-default" id="cancel_button">Cancel</button>
          </div>
        </div>
      </div>
      <div class="col-md-6" id="graph"></div>
      <div class="col-md-3" id="stdout">
        <div class="container-fluid" id="stdout_group">
            <h3>STANDARD OUTPUT</h3>
            <div class="tab-pane active" id="stdout_body">
            </div>    
        </div>
      </div>
      <div class="col-md-12" id="footer">
        <footer class="footer navbar-fixed-bottom">
         <div class="panel-group" id="panel_group">
          <div class="panel panel-default" id="panel_default">
            <div class="panel-heading" id="panel_head">Server Response</div>
            <div class="panel-body" id="panel_body">Debug</div>
          </div>
        </div>
        </footer>
      </div>
    </div>
  </div>
  

  <script>
    var json;

    function refresh(){
      location.reload();
    }

// Function to manage checkboxes
  	$("#prune_absolute").change(function() {
  		document.getElementById("prune_z").checked = !document.getElementById("prune_absolute").checked;
  	})
  	$("#prune_z").change(function() {
  		document.getElementById("prune_absolute").checked = !document.getElementById("prune_z").checked;
  	})
  	$("#cluster_absolute").change(function() {
  		document.getElementById("cluster_z").checked = !document.getElementById("cluster_absolute").checked;
  	})
  	$("#cluster_z").change(function() {
  		document.getElementById("cluster_absolute").checked = !document.getElementById("cluster_z").checked;
  	})

// Prepend all the requests of a specific domain to the panel
function printRequests(d) {
    $("#request_text").prepend("<br><br>");
    for (var i = 0; i < d.length; i++) {
      $("#request_text").prepend(d[i].type + "<br><br>");
      $("#request_text").prepend(d[i].peerhost + " ");
      $("#request_text").prepend(d[i].peerstatus + "/");
      $("#request_text").prepend(d[i].url + " - ");
      $("#request_text").prepend(d[i].method + " ");
      $("#request_text").prepend(d[i].bytes + " ");
      $("#request_text").prepend(d[i].status + " ");
      $("#request_text").prepend(d[i].code + "/");
      $("#request_text").prepend(d[i].client + " ");
      $("#request_text").prepend(d[i].elapsed + " ");
      $("#request_text").prepend(d[i].time.toString().substring(0,10) + "." + d[i].time.toString().substring(10,13) + " ");       
    }
    $("#request_text").prepend(d[0].domain.bold().big() + "<br><br>");
  }

// Functions to do with populating the User-List
    $(document).ready(function(){
        var users;
        // JSON-RPC call to method GetUsers()
        var jsonbody = {"jsonrpc": "2.0",
                        "method": "getUsers",
                        "id": 167
                        };
        var request = json_post("http://127.0.0.1:8080" , jsonbody); 
        users = request.addEventListener('load', function(){
            if (request.readyState == 4 && request.status == 200){
              json = JSON.parse(request.responseText);
              users = json.result;
              //console.log("Server Response: " + json.result);
              $("#panel_head").text('Request Status = ' + request.status + ' ' + request.statusText);
              $("#panel_head").css('color', 'green');
              $("#panel_body").text("Server Response: " + json.result.length + " Users loaded");
            }
            else if (request.status != 400) {
              $("#panel_head").text('Request Status Error = ' + request.status + ' ' + request.statusText);
              $("#panel_head").css('color', 'red');
              $("#panel_body").text("Server Response: Users can't be loaded");
            }

            for (var i = 0; i < users.length; i++){
              $('#user-list ul').append('<li><a href="#" user="' + users[i] + '">' + users[i] + '</a></li>');
            }

            $(".dropdown-menu li a").click(function(){
              var selText = $(this).text();
              $(this).parents('.dropdown').find('.dropdown-toggle').html(selText+ '<span class="caret"></span>');
            });
          });
    });

 // Functions to do with taking the variables filled in the fields
 // and creating a request to the server for method analyze()   
    $("#apply_button").click(function(){
     if ( !$("#time").val() || !$("#url").val() || !$("#domain").val() ||
          parseFloat($("#time").val()) < 0.0 || parseFloat($("#url").val()) < 0.0 || parseFloat($("#domain").val()) < 0.0 ||
          ((parseFloat($("#time").val()) + parseFloat($("#url").val()) + parseFloat($("#domain").val())) != 1.0) ||
          !$("#ord_weights_high").val() || !$("#ord_weights_low").val() ||
          parseFloat($("#ord_weights_high").val()) < 0.0 || parseFloat($("#ord_weights_low").val()) < 0.0 ||
          ((parseFloat($("#ord_weights_high").val()) + parseFloat($("#ord_weights_low").val())) != 1.0) ||
          !$("#prune_threshold").val() || !$("#max_cluster_size").val() ||
          $("#selected-user").text() == "User List" ||
          (prune_absolute.checked == prune_z.checked) ||
          (prune_absolute.checked && $("#prune_threshold").val() < 0) ||
          (cluster_absolute.checked == cluster_z.checked) ||
          (cluster_absolute.checked && $("#max_cluster_size").val() < 0)){
            alert("Some of the parameter values are wrong!");
            return;
      }
      var selecteduser = $("#selected-user").text();
      var jsonbody = {"jsonrpc": "2.0",
                        "method": "analyze",
                        "params": [
                        selecteduser,
                        [$("#time").val(), $("#url").val(), $("#domain").val()],
                        [$("#ord_weights_high").val(), $("#ord_weights_low").val()],
                        $("#prune_threshold").val(),
                        $("#max_cluster_size").val(),
                        children.checked,
                        prune_z.checked,
                        cluster_z.checked,
                        whitelist.checked],
                        "id": 167
                      };
      var request = json_post("http://127.0.0.1:8080" , jsonbody); 
      request.addEventListener('load', function(){
        if (request.readyState == 4 && request.status == 200){
          json = JSON.parse(request.responseText);
          if (json.result != null) {
            //console.log("Server Response: " + json.result);
            $("#panel_head").text('Request Status = ' + request.status + ' ' + request.statusText);
            $("#panel_head").css('color', 'green');
            $("#panel_body").text("Server Response: " + json.result.filtered.length + " Clusters");
            draw_graph(json.result.filtered, printRequests); 
            $("#request_text").html("");
            $("#stdout_body").prepend(json.result.stdout);
            $("#histogram_pruning").on('shown.bs.modal', function() {
                // Function to draw an histogram
                  var data = Chartist.deserialize(json.result.histPruning.array);
                  var options = {
                    referenceValue: 0,
                    axisX: {
                      type: Chartist.AutoScaleAxis,
                    },
                    axisY: {
                	  onlyInteger: true,
                      type: Chartist.AutoScaleAxis,
                    },
                    plugins: [
                      Chartist.plugins.ctAxisTitle({
                        axisX: {
                          axisTitle: 'Value of Similarity',
                          axisClass: 'ct-axis-title',
                          offset: {
                            x: 0,
                            y: 30
                        },
                        textAnchor: 'middle'
                        },
                        axisY: {
                          axisTitle: 'Number of links',
                          axisClass: 'ct-axis-title',
                          offset: {
                            x: 0,
                            y: -10
                          },
                          textAnchor: 'middle',
                          flipTitle: false
                        }
                      }),
                      Chartist.plugins.tooltip(),
                      Chartist.plugins.zoom({ onZoom : onZoom})
                    ]
                  };

                  var chart = Chartist.Line("#chart_pruning", data, options);
                  var resetFnc;

                  // Functions to zoom on histogram
                  function onZoom(chart, reset) {
                    document.getElementById("reset_button_pruning").style.display = 'inline';
                    resetFnc = reset;         
                  }

                  function reset() {
                    resetFnc && resetFnc();
                    resetFnc = null;
                    document.getElementById("reset_button_pruning").style.display = 'none';
                  }
                  $("#reset_button_pruning").click(function() {
                    return reset();
                  });
              });

            $("#histogram_cluster").on('shown.bs.modal', function() {
                // Function to draw an histogram
                  var data = Chartist.deserialize(json.result.histCluster.array);
                  var options = {
                    referenceValue: 0,
                    axisX: {
                      type: Chartist.AutoScaleAxis,
                      onlyInteger: true,
                    },
                    axisY: {
                      type: Chartist.AutoScaleAxis,
                    },
                    plugins: [
                      Chartist.plugins.ctAxisTitle({
                        axisX: {
                          axisTitle: 'Size of Clusters',
                          axisClass: 'ct-axis-title',
                          offset: {
                            x: 0,
                            y: 30
                        },
                        textAnchor: 'middle'
                        },
                        axisY: {
                          axisTitle: 'Number of Clusters',
                          axisClass: 'ct-axis-title',
                          offset: {
                            x: 0,
                            y: -10
                          },
                          textAnchor: 'middle',
                          flipTitle: false
                        }
                      }),
                      Chartist.plugins.tooltip(),
                      Chartist.plugins.zoom({ onZoom : onZoom})
                    ]
                  };
                  var chart = Chartist.Line("#chart_cluster", data, options);
                  var resetFnc;
                  // Functions to zoom on histogram
                  function onZoom(chart, reset) {
                    document.getElementById("reset_button_cluster").style.display = 'inline';
                    resetFnc = reset;         
                  }
                  function reset() {
                    resetFnc && resetFnc();
                    resetFnc = null;
                    document.getElementById("reset_button_cluster").style.display = 'none';
                  }
                  $("#reset_button_cluster").click(function() {
                    return reset();
                  });
              });

            document.getElementById("show_all_domains_button").style.display = 'inline';
            $("#show_all_domains_button").click(function() {
              for (var i = 0; i < json.result.filtered.length; i++) {
                for (var j = 0; j < json.result.filtered[i].nodes.length; j++) {
                  printRequests(json.result.filtered[i].nodes[j].requests);
                }
              }
            });
          } else {
            $("#panel_head").text('Request Status Error = ' + request.status + ' ' + request.statusText);
            $("#panel_head").css('color', 'red');
            $("#panel_body").text("Server Response is empty ! (Input values are probably wrong)");
          }
        } else {
          $("#panel_head").text('Request Status Error = ' + request.status + ' ' + request.statusText);
          $("#panel_head").css('color', 'red');
          $("#panel_body").text("Server Response: " + json.result.filtered.length + " Clusters");

        } 
      });
    });
    $("#cancel_button").click(function(){
      location.reload();
    })
  </script>
</body>
