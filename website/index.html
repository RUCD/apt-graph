<!doctype html>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<head>
  <title>APT-GRAPH</title>
  <!-- CSS -->
  <link rel="stylesheet" type="text/css" href="css/stylesheet.css">
  <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
  <link rel="stylesheet" href="chartist/chartist.min.css">
  <link rel="stylesheet" href="chartist/tooltip/chartist-plugin-tooltip.css">
</head>
<body>
  <!-- Js -->
  <script src="js/libs/jquery-3.1.1.min.js"></script>
  <script src="js/libs/d3.min.js"></script>
  <script src="js/libs/bootstrap.min.js"></script>
  <script src="js/graph.js"></script>
  <script src="js/json_methods.js"></script>
  <script src="js/change_visibility.js"></script>
  <script src="chartist/chartist.js"></script>
  <script src="chartist/axistitle/chartist-plugin-axistitle.js"></script>
  <script src="chartist/tooltip/chartist-plugin-tooltip.js"></script>
  <script src="chartist/zoom/chartist-plugin-zoom.min.js"></script>

  <div class="container-fluid" id="container">
    <div class="row" id="parent">
      <div class="col-md-2" id="side_bar">
        <div class="container-fluid" id="choice_user">
          <h3>CHOICE OF USER</h3>
            <div class="dropdown" id="user-list">
              <a class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" href="#" id="selected-user">User List<span class="caret"></span></a>
              <ul class="dropdown-menu">
              </ul>
            </div> 
        </div>
        <div class="container-fluid" id="feature_fusion">
          <h3>FEATURE FUSION</h3>
          <h4>FEATURE WEIGHTS</h4>
          <div class="form-horizontal">
            <div class="form-group">
              <label for="time" class="col-md-2 control-label" style="text-align: left; width: 100px;">TIME:</label>
              <div class="col-md-4">
                <input type="number" step="0.1" class="form-control" id="time" value="0.6" style="width: 100px;">
              </div>
            </div>
            <div class="form-group">
              <label for="url" class="col-md-2 control-label" style="text-align: left; width: 100px;">URL:</label>
              <div class="col-md-4">
                <input type="number" step="0.1" class="form-control" id="url" value="0" style="width: 100px;">
              </div>
            </div>
            <div class="form-group">
              <label for="domain" class="col-md-2 control-label" style="text-align: left; width: 100px;">DOMAIN:</label>
              <div class="col-md-4">
                <input type="number" step="0.1" class="form-control" id="domain" value="0.4" style="width: 100px;">
              </div>
            </div>
            <div class="form-group">
              <label for="children" class="col-md-2 control-label" style="text-align: left; width: 200px;">TEMPORAL CHILDREN:</label>
              <div class="col-md-4">
                <input type="checkbox" id="children" value="" checked>
              </div>
            </div>
          </div>
          <h4>ORDERED WEIGHTS</h4>
          <div class="form-group">
            <input type="number" class="form-control" id="ord_weights_high" value="0.8" style="width: 100px; float: left; margin-right: 10px;">
            <input type="number" class="form-control" id="ord_weights_low" value="0.2" style="width: 100px; float: left; margin-right: 10px;">
          </div>
        </div>
        <div class="container-fluid" id="domain_clustering">
          <h3>DOMAIN CLUSTERING</h3>
          <div class="form-horizontal">
            <div class="form-group">
              <label for="prune_threshold" class="col-md-4 control-label" style="text-align: left; width: 200px;">PRUNE THRESHOLD (z):</label>
            </div>
            <div class="form-group">
              <div class="col-md-12">
                <input type="number" step="0.01" class="form-control" id="prune_threshold" value="-0.25" style="width: 100px; float: left; margin-right: 10px;">
                <button type="button" class="btn btn-default" data-toggle="modal" data-target="#histogram_pruning" style="width: 100px; float: left; margin-right: 10px">
                  Histogram
                </button>
                <div class="modal fade" id="histogram_pruning" role="dialog">
                  <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h2 class="modal-title">Pruning Threshold Histogram</h2>
                      </div>
                      <div class="modal-body" id="hist_pruning">
                        <div class="ct-chart ct-perfect-fourth" id="chart_pruning"></div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-default" id="reset_button_pruning" style="display:none">Reset Zoom</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="max_cluster_size" class="col-md-4 control-label" style="text-align: left; width: 200px;">MAX CLUSTER SIZE (z):</label>
            </div>
            <div class="form-group">
              <div class="col-md-12">
                <input type="number" step="0.01" class="form-control" id="max_cluster_size" value="0" style="width: 100px; float: left; margin-right: 10px;">
                <button type="button" class="btn btn-default" data-toggle="modal" data-target="#histogram_cluster" style="width: 100px; float: left; margin-right: 10px;">
                  Histogram
                </button>
                <div class="modal fade" id="histogram_cluster" role="dialog">
                  <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h2 class="modal-title">Cluster Size Histogram</h2>
                      </div>
                      <div class="modal-body" id="hist_cluster">
                        <div class="ct-chart ct-perfect-fourth" id="chart_cluster"></div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-default" id="reset_button_cluster" style="display:none">Reset Zoom</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div> 
        </div>
        <div class="container-fluid" id="domain_display">
          <h3>DOMAIN DISPLAY</h3>
          <div class="form-horizontal">
            <div class="form-group">
             <label for="whitelist" class="col-md-2 control-label" style="text-align: left; width: 150px;">WHITE LISTING</label>
             <div class="col-md-4">
               <input type="checkbox" id="whitelist" value="" checked>
             </div>
            </div>
          </div>  
        </div>
        <div class="container-fluid" id="buttons">
          <button type="button" class="btn btn-primary" id="apply_button">Apply</button>
          <button type="button" class="btn btn-default" id="cancel_button">Cancel</button>
        </div>
      </div>
      <div class="col-md-7" id="graph"></div>
      <div class="col-md-3" id="stdout">
        <div class="container-fluid" id="stdout_group">
            <h3>STANDARD OUTPUT</h3>
            <div class="tab-pane active" id="stdout_body">
            </div>    
        </div>
      </div>
      <div class="col-md-12" id="footer">
        <footer class="footer navbar-fixed-bottom">
         <div class="panel-group" id="panel_group">
          <div class="panel panel-default" id="panel_default">
            <div class="panel-heading" id="panel_head">Server Response</div>
            <div class="panel-body" id="panel_body">Debug</div>
          </div>
        </div>
        </footer>
      </div>
    </div>
  </div>
  

  <script>
    var json;

    function refresh(){
      location.reload();
    }

// Functions to do with populating the User-List
    $(document).ready(function(){
        var users;
        // JSON-RPC call to method GetUsers()
        var jsonbody = {"jsonrpc": "2.0",
                        "method": "getUsers",
                        "id": 123
                        };
        var request = json_post("http://127.0.0.1:8080" , jsonbody); 
        users = request.addEventListener('load', function(){
            if (request.readyState == 4 && request.status == 200){
              json = JSON.parse(request.responseText);
              users = json.result;
              //console.log("Server Response: " + json.result);
              $("#panel_head").text('Request Status = ' + request.status + ' ' + request.statusText);
              $("#panel_head").css('color', 'green');
              $("#panel_body").text("Server Response: " + json.result.length + " Users loaded");
            }
            else if (request.status != 400) {
              $("#panel_head").text('Request Status Error = ' + request.status + ' ' + request.statusText);
              $("#panel_head").css('color', 'red');
              $("#panel_body").text("Server Response: Users can't be loaded");
            }

            for (var i = 0; i < users.length; i++){
              $('#user-list ul').append('<li><a href="#" user="' + users[i] + '">' + users[i] + '</a></li>');
            }

            $(".dropdown-menu li a").click(function(){
              var selText = $(this).text();
              $(this).parents('.dropdown').find('.dropdown-toggle').html(selText+ '<span class="caret"></span>');
            });
          });
    });


 // Functions to do with taking the variables filled in the fields
 // and creating a request to the server for method analyze()   
    $("#apply_button").click(function(){
     if ( !$("#time").val() || !$("#url").val() || !$("#domain").val() ||
          !$("#ord_weights_high").val() || !$("#ord_weights_low").val() ||
          !$("#prune_threshold").val() || !$("#max_cluster_size").val() ||
          $("#selected-user").text() == "User List"){
            alert("Some of the parameter values are empty!");
            return;
      }
      var selecteduser = $("#selected-user").text();
      var jsonbody = {"jsonrpc": "2.0",
                        "method": "analyze",
                        "params": [
                        selecteduser,
                        [$("#time").val(), $("#url").val(), $("#domain").val()],
                        [$("#ord_weights_high").val(), $("#ord_weights_low").val()],
                        $("#prune_threshold").val(),
                        $("#max_cluster_size").val(),
                        children.checked,
                        whitelist.checked],
                        "id": 123
                      };
      var request = json_post("http://127.0.0.1:8080" , jsonbody); 
      request.addEventListener('load', function(){
        if (request.readyState == 4 && request.status == 200){
          json = JSON.parse(request.responseText);
          if (json.result != null) {
            //console.log("Server Response: " + json.result);
            $("#panel_head").text('Request Status = ' + request.status + ' ' + request.statusText);
            $("#panel_head").css('color', 'green');
            $("#panel_body").text("Server Response: " + json.result.filtered.length + " Clusters");
            draw_graph(json.result.filtered); 
            $("#stdout_body").prepend(json.result.stdout);
            $("#histogram_pruning").on('shown.bs.modal', function() {
                // Function to draw an histogram
                  var data = Chartist.deserialize(json.result.histPruning.array);
                  var options = {
                    referenceValue: 0,
                    axisX: {
                      type: Chartist.AutoScaleAxis,
                    },
                    axisY: {
                      type: Chartist.AutoScaleAxis,
                    },
                    plugins: [
                      Chartist.plugins.ctAxisTitle({
                        axisX: {
                          axisTitle: 'Value of Similarity (z)',
                          axisClass: 'ct-axis-title',
                          offset: {
                            x: 0,
                            y: 30
                        },
                        textAnchor: 'middle'
                        },
                        axisY: {
                          axisTitle: 'Number of links',
                          axisClass: 'ct-axis-title',
                          offset: {
                            x: 0,
                            y: -10
                          },
                          textAnchor: 'middle',
                          flipTitle: false
                        }
                      }),
                      Chartist.plugins.tooltip(),
                      Chartist.plugins.zoom({ onZoom : onZoom, pointClipOffset : 10 })
                    ]
                  };

                  var chart = Chartist.Line("#chart_pruning", data, options);
                  var resetFnc;

                  // Functions to zoom on histogram
                  function onZoom(chart, reset) {
                    document.getElementById("reset_button_pruning").style.display = 'inline';
                    resetFnc = reset;         
                  }

                  function reset() {
                    resetFnc && resetFnc();
                    resetFnc = null;
                    document.getElementById("reset_button_pruning").style.display = 'none';
                  }
                  $("#reset_button_pruning").click(function() {
                    return reset();
                  });
              });

            $("#histogram_cluster").on('shown.bs.modal', function() {
                // Function to draw an histogram
                  var data = Chartist.deserialize(json.result.histCluster.array);
                  var options = {
                    referenceValue: 0,
                    axisX: {
                      type: Chartist.AutoScaleAxis,
                    },
                    axisY: {
                      type: Chartist.AutoScaleAxis,
                    },
                    plugins: [
                      Chartist.plugins.ctAxisTitle({
                        axisX: {
                          axisTitle: 'Size of Clusters (z)',
                          axisClass: 'ct-axis-title',
                          offset: {
                            x: 0,
                            y: 30
                        },
                        textAnchor: 'middle'
                        },
                        axisY: {
                          axisTitle: 'Number of Clusters',
                          axisClass: 'ct-axis-title',
                          offset: {
                            x: 0,
                            y: -10
                          },
                          textAnchor: 'middle',
                          flipTitle: false
                        }
                      }),
                      Chartist.plugins.tooltip(),
                      Chartist.plugins.zoom({ onZoom : onZoom, pointClipOffset : 10 })
                    ]
                  };
                  var chart = Chartist.Line("#chart_cluster", data, options);
                  var resetFnc;
                  // Functions to zoom on histogram
                  function onZoom(chart, reset) {
                    document.getElementById("reset_button_cluster").style.display = 'inline';
                    resetFnc = reset;         
                  }
                  function reset() {
                    resetFnc();
                    resetFnc = null;
                    document.getElementById("reset_button_cluster").style.display = 'none';
                  }
                  $("#reset_button_cluster").click(function() {
                    return reset();
                  });
              });
          } else {
            $("#panel_head").text('Request Status Error = ' + request.status + ' ' + request.statusText);
            $("#panel_head").css('color', 'red');
            $("#panel_body").text("Server Response is empty ! (Weights are probably wrong)");
          }
        } else if (request.status != 400) {
          $("#panel_head").text('Request Status Error = ' + request.status + ' ' + request.statusText);
          $("#panel_head").css('color', 'red');
          $("#panel_body").text("Server Response: " + json.result.filtered.length + " Clusters");

        } 
      });
    });
    $("#cancel_button").click(function(){
      location.reload();
    })
  </script>
</body>
